@{
    Layout = "_GetTicketLayout";
    ViewData["Title"] = "Thanh toán";
}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Banner -->
    <div
        class="relative w-full h-56 md:h-64 bg-gradient-to-b from-blue-100 to-white flex items-center justify-center mb-8">
        <img src="https://res.cloudinary.com/dgkrchato/image/upload/v1717570732/bamboo-banner.png" alt="Bamboo Airways"
            class="absolute inset-0 w-full h-full object-cover object-top" style="z-index:1;">
        <div class="absolute top-10 left-1/2 -translate-x-1/2 z-10">
            <div class="bg-white rounded-xl shadow-lg px-8 py-4 text-center">
                <h1 class="text-2xl md:text-3xl font-bold text-green-700">Thanh toán</h1>
            </div>
        </div>
    </div>
    <div class="max-w-3xl mx-auto mb-8">
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
            <div class="text-lg font-bold text-green-700 mb-2">Tổng giá: <span id="paymentTotal">0 VND</span></div>
            <div class="text-xs text-gray-600 mb-2">Tổng giá đặt vé <a href="#" class="underline">Điều kiện</a> <a
                    href="#" class="underline">Chính sách hành lý chi tiết</a></div>
        </div>
    </div>
    <div class="max-w-3xl mx-auto mb-8">
        <div class="bg-white rounded-xl shadow p-6">
            <div class="font-bold text-blue-900 text-xl mb-4">Chọn phương thức thanh toán của Quý khách</div>
            <div class="space-y-4" id="paymentAccordion">
                <!-- Card -->
                <div class="border rounded-xl">
                    <div class="flex items-center justify-between p-4 cursor-pointer group" data-method="card">
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold">Thẻ ghi nợ / Thẻ tín dụng</span>
                            <img src="https://digital.bambooairways.com/statics/applications/booking/dynamicContent/1.0.10/assets/icons/payment/visa.png"
                                class="h-6" />
                            <img src="https://digital.bambooairways.com/statics/applications/booking/dynamicContent/1.0.10/assets/icons/payment/mastercard.png"
                                class="h-6" />
                            <img src="https://digital.bambooairways.com/statics/applications/booking/dynamicContent/1.0.10/assets/img/payment/jcb_emblem_logo.svg"
                                class="h-6" />
                        </div>
                        <svg class="w-6 h-6 text-green-700 group-[.active]:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="p-4 border-t hidden" id="content-card">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1 flex items-center justify-center">
                                <div
                                    class="bg-gradient-to-br from-blue-200 to-blue-400 rounded-xl w-72 h-40 flex flex-col justify-between p-6 shadow">
                                    <div class="text-white text-xl font-bold tracking-widest">XXXX XXXX XXXX XXXX</div>
                                    <div class="flex justify-between text-white text-sm mt-6">
                                        <div>
                                            <div class="font-semibold">Tên chủ thẻ</div>
                                            <div>XXX</div>
                                        </div>
                                        <div>
                                            <div class="font-semibold">Ngày hết hạn</div>
                                            <div>XX/XX</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- VietQR -->
                <div class="border rounded-xl">
                    <div class="flex items-center justify-between p-4 cursor-pointer group" data-method="vietqr">
                        <div class="flex items-center gap-4">
                            <img src="https://digital.bambooairways.com/statics/applications/booking/dynamicContent/1.0.10/assets/img/payment/vietqr-vi.png"
                                class="h-6" />
                            <span class="text-lg font-bold">Thanh toán bằng mã VietQR</span>
                        </div>
                        <svg class="w-6 h-6 text-green-700 group-[.active]:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="p-4 border-t hidden" id="content-vietqr">
                        <div class="text-gray-700">Hướng dẫn hoặc mã QR sẽ hiển thị ở đây.</div>
                    </div>
                </div>

                <div class="border rounded-xl">
                    <div class="flex items-center justify-between p-4 cursor-pointer group" data-method="momo">
                        <div class="flex items-center gap-4">
                            <img src="https://digital.bambooairways.com/statics/applications/booking/dynamicContent/1.0.10/assets/img/payment/momo-vi.png"
                                class="h-6" />
                            <span class="text-lg font-bold">Ví điện tử Momo</span>
                        </div>
                        <svg class="w-6 h-6 text-green-700 group-[.active]:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="p-4 border-t hidden" id="content-momo">
                        <div class="mb-4">
                            <ul class="text-gray-700 text-sm list-disc ml-6 mb-4">
                                <li>Dễ dàng thanh toán bằng cách quét mã QR tại ứng dụng Momo</li>
                                <li>Quý khách sẽ được chuyển hướng sang trang của Momo để thực hiện khoản thanh toán của
                                    mình.</li>
                                <li>Để thanh toán bằng Ví điện tử Momo, Quý khách vui lòng đặt mua vé trên máy tính cá
                                    nhân và không sử dụng thiết bị cầm tay.</li>
                            </ul>
                        </div>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="momoAgree" class="accent-green-600" />
                            <label for="momoAgree" class="text-xs">Tôi hiểu và đồng ý với <a href="#"
                                    class="text-green-700 underline">Điều lệ vận chuyển</a>, <a href="#"
                                    class="text-green-700 underline">Điều kiện sử dụng chức năng đặt chỗ trực tuyến</a>,
                                <a href="#" class="text-green-700 underline">Chính sách bảo mật</a> và <a href="#"
                                    class="text-green-700 underline">Điều kiện giá vé</a> của Bamboo Airways. <a
                                    href="#" class="text-green-700 underline">Xem điều kiện</a></label>
                        </div>
                    </div>
                </div>
                <!-- ATM -->
                <div class="border rounded-xl">
                    <div class="flex items-center justify-between p-4 cursor-pointer group" data-method="atm">
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold">Thẻ ATM / Thẻ nội địa</span>
                        </div>
                        <svg class="w-6 h-6 text-green-700 group-[.active]:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="p-4 border-t hidden" id="content-atm">
                        <div class="text-gray-700">Hướng dẫn thanh toán qua ATM sẽ hiển thị ở đây.</div>
                    </div>
                </div>
                <!-- Trả sau -->
                <div class="border rounded-xl">
                    <div class="flex items-center justify-between p-4 cursor-pointer group" data-method="later">
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold">Trả sau</span>
                            <span class="text-xs text-gray-600">Đặt chỗ ngay, thanh toán trả sau dễ dàng</span>
                        </div>
                        <svg class="w-6 h-6 text-green-700 group-[.active]:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="p-4 border-t hidden" id="content-later">
                        <div class="text-gray-700">Hướng dẫn thanh toán trả sau sẽ hiển thị ở đây.</div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button
                    id="btnConfirmPay"
                    class="bg-green-700 hover:bg-green-800 text-white font-bold px-8 py-3 rounded-lg shadow transition">Xác
                    nhận thanh toán</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function formatPrice(price) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(price);
            }
            function updatePaymentTotal() {
                let total = 0;
                let bookingDetails = JSON.parse(sessionStorage.getItem('bookingDetails') || 'null');
                if (bookingDetails && bookingDetails.totalPrice) {
                    total = bookingDetails.totalPrice;
                }
                document.getElementById('paymentTotal').textContent = formatPrice(total);
            }
            updatePaymentTotal();
            window.addEventListener('focus', updatePaymentTotal);
            // Accordion toggle
            const headers = document.querySelectorAll('#paymentAccordion .group');
            const contents = document.querySelectorAll('#paymentAccordion > div > .p-4.border-t');
            headers.forEach(header => {
                header.addEventListener('click', function () {
                    const method = header.getAttribute('data-method');
                    const content = document.getElementById('content-' + method);
                    const isOpen = !content.classList.contains('hidden');
                    if (isOpen) {
                        content.classList.add('hidden');
                        header.classList.remove('active');
                    } else {
                        content.classList.remove('hidden');
                        header.classList.add('active');
                    }
                });
            });
            // Mặc định mở Card
            if (headers.length) headers[0].click();

            // Kiểm tra thông tin thẻ khi bấm nút Thanh toán
            var btnCardPay = document.getElementById('btnCardPay');
            if (btnCardPay) {
                btnCardPay.addEventListener('click', function (e) {
                    let valid = true;
                    let errors = [];
                    const cardSection = document.getElementById('content-card');
                    const cardError = document.getElementById('cardError');
                    // Lấy các trường
                    const cardNumber = cardSection.querySelector('input[placeholder="Số thẻ tín dụng *"]');
                    const month = cardSection.querySelector('input[placeholder="Tháng"]');
                    const year = cardSection.querySelector('input[placeholder="Năm"]');
                    const cvc = cardSection.querySelector('input[placeholder="Nhập CVV *"]');
                    const cardName = cardSection.querySelector('input[placeholder="Tên đầy đủ của chủ thẻ *"]');
                    const agree = document.getElementById('cardAgree');

                    // Kiểm tra từng trường
                    if (!cardNumber.value.trim()) {
                        valid = false;
                        errors.push("Vui lòng nhập số thẻ tín dụng.");
                        cardNumber.classList.add('border-red-500');
                    } else {
                        cardNumber.classList.remove('border-red-500');
                    }
                    if (!month.value.trim()) {
                        valid = false;
                        errors.push("Vui lòng nhập tháng hết hạn.");
                        month.classList.add('border-red-500');
                    } else {
                        month.classList.remove('border-red-500');
                    }
                    if (!year.value.trim()) {
                        valid = false;
                        errors.push("Vui lòng nhập năm hết hạn.");
                        year.classList.add('border-red-500');
                    } else {
                        year.classList.remove('border-red-500');
                    }
                    if (!cvc.value.trim()) {
                        valid = false;
                        errors.push("Vui lòng nhập mã bảo mật.");
                        cvc.classList.add('border-red-500');
                    } else {
                        cvc.classList.remove('border-red-500');
                    }
                    if (!cardName.value.trim()) {
                        valid = false;
                        errors.push("Vui lòng nhập tên chủ thẻ.");
                        cardName.classList.add('border-red-500');
                    } else {
                        cardName.classList.remove('border-red-500');
                    }
                    if (!agree.checked) {
                        valid = false;
                        errors.push("Bạn phải đồng ý với các điều khoản.");
                        agree.classList.add('ring-2', 'ring-red-500');
                    } else {
                        agree.classList.remove('ring-2', 'ring-red-500');
                    }
                });
            }
            // Nút xác nhận thanh toán (dưới cùng)
            document.getElementById('btnConfirmPay').addEventListener('click', function (e) {
                e.preventDefault();
                const bookingDetails = JSON.parse(sessionStorage.getItem('bookingDetails') || 'null');
                if (!bookingDetails) {
                    alert('Không tìm thấy thông tin đặt vé!');
                    return;
                }
                fetch('/get-ticket/save-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingDetails)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/booking/success';
                    } else {
                        alert('Có lỗi xảy ra khi lưu thông tin đặt vé!');
                    }
                })
                .catch(() => alert('Có lỗi xảy ra khi gửi dữ liệu!'));
            });
        });
    </script>
</body>

</html>